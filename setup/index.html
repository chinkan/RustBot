<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RustFox Setup</title>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    background: #0f1117;
    color: #e2e8f0;
    min-height: 100vh;
    display: flex;
    align-items: flex-start;
    justify-content: center;
    padding: 2rem;
  }
  .card {
    background: #1a1f2e;
    border: 1px solid #2d3748;
    border-radius: 16px;
    width: 100%;
    max-width: 700px;
    padding: 2.5rem;
    margin-top: 2rem;
  }
  /* Progress bar */
  .progress-wrap { margin-bottom: 2rem; }
  .progress-label { font-size: 0.75rem; color: #718096; margin-bottom: 0.5rem; }
  .progress-bar { height: 4px; background: #2d3748; border-radius: 2px; }
  .progress-fill { height: 100%; background: #f6851b; border-radius: 2px; transition: width 0.3s ease; }
  /* Steps */
  .step { display: none; }
  .step.active { display: block; }
  h1 { font-size: 1.75rem; font-weight: 700; margin-bottom: 0.5rem; }
  h2 { font-size: 1.25rem; font-weight: 600; margin-bottom: 1.5rem; color: #cbd5e0; }
  p.subtitle { color: #718096; margin-bottom: 2rem; line-height: 1.6; }
  code { background: #2d3748; border-radius: 4px; padding: 0.1em 0.35em; font-size: 0.85em; }
  /* Form elements */
  .field { margin-bottom: 1.25rem; }
  label { display: block; font-size: 0.875rem; font-weight: 500; margin-bottom: 0.4rem; color: #cbd5e0; }
  label .hint { font-weight: 400; color: #718096; margin-left: 0.4rem; }
  input[type=text], input[type=password], textarea {
    width: 100%;
    background: #0f1117;
    border: 1px solid #2d3748;
    border-radius: 8px;
    color: #e2e8f0;
    padding: 0.6rem 0.875rem;
    font-size: 0.9rem;
    font-family: inherit;
    transition: border-color 0.2s;
  }
  input[type=text]:focus, input[type=password]:focus, textarea:focus {
    outline: none;
    border-color: #f6851b;
  }
  input.error, textarea.error { border-color: #fc8181; }
  .error-msg { color: #fc8181; font-size: 0.8rem; margin-top: 0.3rem; display: none; }
  .error-msg.visible { display: block; }
  textarea { resize: vertical; min-height: 90px; }
  /* Buttons */
  .btn-row { display: flex; gap: 0.75rem; justify-content: flex-end; margin-top: 2rem; }
  button {
    padding: 0.6rem 1.4rem;
    border-radius: 8px;
    border: none;
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    transition: opacity 0.15s;
  }
  button:hover:not(:disabled) { opacity: 0.85; }
  button:disabled { opacity: 0.45; cursor: default; }
  .btn-primary { background: #f6851b; color: #fff; }
  .btn-secondary { background: #2d3748; color: #e2e8f0; }
  /* MCP tools */
  .mcp-category { margin-bottom: 1.5rem; }
  .mcp-category h3 { font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.08em; color: #718096; margin-bottom: 0.75rem; }
  .mcp-tool {
    border: 1px solid #2d3748;
    border-radius: 8px;
    padding: 0.75rem 1rem;
    margin-bottom: 0.5rem;
    cursor: pointer;
    transition: border-color 0.2s;
  }
  .mcp-tool:hover { border-color: #4a5568; }
  .mcp-tool.selected { border-color: #f6851b; background: #1e2432; }
  .mcp-tool-header { display: flex; align-items: center; gap: 0.75rem; }
  .mcp-tool-header input[type=checkbox] { accent-color: #f6851b; width: 16px; height: 16px; flex-shrink: 0; cursor: pointer; }
  .mcp-tool-name { font-weight: 600; font-size: 0.9rem; }
  .mcp-tool-desc { font-size: 0.8rem; color: #718096; margin-left: 1.75rem; margin-top: 0.2rem; }
  .mcp-tool-cmd { font-size: 0.75rem; color: #4a5568; font-family: monospace; margin-left: 1.75rem; margin-top: 0.15rem; }
  .mcp-env-fields { margin-left: 1.75rem; margin-top: 0.75rem; display: none; }
  .mcp-env-fields.visible { display: block; }
  .mcp-env-fields .env-row { margin-bottom: 0.5rem; }
  .mcp-env-label { font-size: 0.75rem; color: #718096; margin-bottom: 0.2rem; }
  .mcp-env-fields input { font-family: monospace; font-size: 0.82rem; }
  /* MCP prereqs box */
  .mcp-prereqs {
    background: #131825;
    border: 1px solid #2d3748;
    border-radius: 8px;
    padding: 0.75rem 1rem;
    margin-bottom: 1.5rem;
    font-size: 0.82rem;
    color: #718096;
    line-height: 1.7;
  }
  .mcp-prereqs strong { color: #cbd5e0; }
  .mcp-prereqs a { color: #f6851b; text-decoration: none; }
  .mcp-prereqs a:hover { text-decoration: underline; }
  /* Per-tool docs link */
  .mcp-tool-link {
    margin-left: auto;
    font-size: 0.72rem;
    color: #4a5568;
    text-decoration: none;
    flex-shrink: 0;
    padding: 0.1rem 0.3rem;
  }
  .mcp-tool-link:hover { color: #f6851b; }
  /* Find more footer */
  .mcp-more {
    margin-top: 1.25rem;
    font-size: 0.8rem;
    color: #718096;
    text-align: center;
  }
  .mcp-more a { color: #f6851b; text-decoration: none; }
  .mcp-more a:hover { text-decoration: underline; }
  /* Custom MCP server section */
  .custom-mcp-section { margin-top: 1.75rem; border-top: 1px solid #2d3748; padding-top: 1.25rem; }
  .custom-mcp-section h3 { font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.08em; color: #718096; margin-bottom: 0.75rem; }
  .custom-card {
    border: 1px solid #2d3748;
    border-radius: 8px;
    padding: 0.65rem 1rem;
    margin-bottom: 0.5rem;
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
  }
  .custom-card-body { flex: 1; min-width: 0; }
  .custom-card-name { font-weight: 600; font-size: 0.9rem; margin-bottom: 0.2rem; }
  .custom-card-cmd { font-size: 0.75rem; color: #4a5568; font-family: monospace; }
  .custom-card-env { font-size: 0.72rem; color: #718096; margin-top: 0.15rem; }
  .btn-remove { background: none; border: none; cursor: pointer; color: #718096; font-size: 1rem; padding: 0; line-height: 1; flex-shrink: 0; }
  .btn-remove:hover { color: #fc8181; opacity: 1; }
  .custom-add-form {
    border: 1px dashed #2d3748;
    border-radius: 8px;
    padding: 1rem;
    margin-top: 0.75rem;
  }
  .custom-add-form h4 { font-size: 0.85rem; font-weight: 600; color: #cbd5e0; margin-bottom: 0.75rem; }
  .cmd-row { display: flex; gap: 0.5rem; }
  .cmd-row select {
    background: #0f1117;
    border: 1px solid #2d3748;
    border-radius: 8px;
    color: #e2e8f0;
    padding: 0.6rem 0.5rem;
    font-size: 0.9rem;
    min-width: 80px;
  }
  .env-add-row { display: flex; gap: 0.5rem; margin-bottom: 0.4rem; }
  .env-add-row input { flex: 1; }
  /* Config preview */
  pre {
    background: #0f1117;
    border: 1px solid #2d3748;
    border-radius: 8px;
    padding: 1rem;
    font-size: 0.78rem;
    overflow: auto;
    max-height: 340px;
    color: #a0aec0;
    white-space: pre;
  }
  .success-msg { color: #68d391; font-size: 0.9rem; margin-top: 1rem; display: none; }
  .success-msg.visible { display: block; }
  .provider-tabs { display: flex; gap: 0; margin-bottom: 1.5rem; border-radius: 8px; overflow: hidden; border: 1px solid #2d3748; }
  .provider-tab { flex: 1; padding: 0.55rem 0; text-align: center; font-size: 0.85rem; font-weight: 600; cursor: pointer; background: #0f1117; color: #718096; border: none; transition: background 0.15s, color 0.15s; }
  .provider-tab.active { background: #f6851b; color: #fff; }
  .provider-tab:hover:not(.active) { background: #1a1f2e; color: #cbd5e0; }
  .provider-panel { display: none; }
  .provider-panel.active { display: block; }
  .ollama-model-row { display: flex; gap: 0.5rem; align-items: flex-start; }
  .ollama-fetch-btn { padding: 0.6rem 1rem; background: #2d3748; color: #e2e8f0; border: none; border-radius: 8px; font-size: 0.85rem; font-weight: 600; cursor: pointer; white-space: nowrap; }
  .ollama-fetch-btn:hover { background: #4a5568; }
  .ollama-status { font-size: 0.78rem; margin-top: 0.3rem; }
  .ollama-status.ok { color: #68d391; }
  .ollama-status.err { color: #fc8181; }
  .openai-custom-wrap { margin-top: 0.5rem; display: none; }
  .openai-custom-wrap.visible { display: block; }
</style>
</head>
<body>
<div class="card">
  <div class="progress-wrap">
    <div class="progress-label" id="progress-label">Step 1 of 6</div>
    <div class="progress-bar"><div class="progress-fill" id="progress-fill" style="width:16.6%"></div></div>
  </div>
  <div id="steps-container"></div>
  <div class="btn-row">
    <button class="btn-secondary" id="btn-back" onclick="prevStep()" style="display:none">← Back</button>
    <button class="btn-primary" id="btn-next" onclick="nextStep()">Get Started →</button>
  </div>
</div>

<script>
// ── MCP Catalog ────────────────────────────────────────────────────────────────
const MCP_CATALOG = [
  { name:'playwright',       category:'Browser & Web',      desc:'Browser automation & web scraping',           runner:'npx', args:['-y','@playwright/mcp'],                          envVars:[],                                           link:'https://www.npmjs.com/package/@playwright/mcp' },
  { name:'brave-search',     category:'Browser & Web',      desc:'Real-time web search via Brave',               runner:'npx', args:['-y','@brave/brave-search-mcp-server'],          envVars:['BRAVE_API_KEY'],                            link:'https://www.npmjs.com/package/@brave/brave-search-mcp-server' },
  { name:'firecrawl',        category:'Browser & Web',      desc:'URL to clean Markdown scraping',               runner:'npx', args:['-y','firecrawl-mcp'],                            envVars:['FIRECRAWL_API_KEY'],                        link:'https://www.npmjs.com/package/firecrawl-mcp' },
  { name:'fetch',            category:'Browser & Web',      desc:'Lightweight page fetching',                    runner:'uvx', args:['mcp-server-fetch'],                              envVars:[],                                           link:'https://pypi.org/project/mcp-server-fetch' },
  { name:'google-workspace', category:'Productivity',       desc:'Gmail, Calendar, Drive, Docs',                 runner:'uvx', args:['google-workspace-mcp'],                          envVars:['GOOGLE_CLIENT_ID','GOOGLE_CLIENT_SECRET'],  link:'https://pypi.org/project/google-workspace-mcp' },
  { name:'notion',           category:'Productivity',       desc:'Read/write Notion workspace',                  runner:'npx', args:['-y','@notionhq/notion-mcp-server'],              envVars:['NOTION_API_KEY'],                           link:'https://www.npmjs.com/package/@notionhq/notion-mcp-server' },
  { name:'obsidian',         category:'Productivity',       desc:'Local Obsidian vault access',                  runner:'npx', args:['-y','obsidian-mcp'],                             envVars:[],                                           link:'https://www.npmjs.com/package/obsidian-mcp' },
  { name:'slack',            category:'Communication',      desc:'Read channels, post Slack messages',           runner:'npx', args:['-y','@modelcontextprotocol/server-slack'],         envVars:['SLACK_BOT_TOKEN'],                          link:'https://www.npmjs.com/package/@modelcontextprotocol/server-slack' },
  { name:'discord',          category:'Communication',      desc:'Send and read Discord messages',               runner:'npx', args:['-y','discord-mcp'],                              envVars:['DISCORD_TOKEN'],                            link:'https://www.npmjs.com/package/discord-mcp' },
  { name:'github',           category:'Developer Tools',    desc:'Issues, PRs, repository management',           runner:'npx', args:['-y','@modelcontextprotocol/server-github'],         envVars:['GITHUB_TOKEN'],                             link:'https://www.npmjs.com/package/@modelcontextprotocol/server-github' },
  { name:'git',              category:'Developer Tools',    desc:'Local git repository operations',              runner:'uvx', args:['mcp-server-git'],                                envVars:[],                                           link:'https://pypi.org/project/mcp-server-git' },
  { name:'filesystem',       category:'Developer Tools',    desc:'Expanded filesystem access beyond sandbox',    runner:'npx', args:['-y','@modelcontextprotocol/server-filesystem'],  envVars:[],                                           link:'https://www.npmjs.com/package/@modelcontextprotocol/server-filesystem' },
  { name:'memory',           category:'Knowledge & Data',   desc:'Persistent cross-session memory graph',        runner:'npx', args:['-y','@modelcontextprotocol/server-memory'],         envVars:[],                                           link:'https://www.npmjs.com/package/@modelcontextprotocol/server-memory' },
  { name:'tavily',           category:'Knowledge & Data',   desc:'AI-optimised semantic web search',             runner:'npx', args:['-y','tavily-mcp'],                               envVars:['TAVILY_API_KEY'],                           link:'https://www.npmjs.com/package/tavily-mcp' },
  { name:'context7',         category:'Knowledge & Data',   desc:'Live library documentation fetching',          runner:'npx', args:['-y','@upstash/context7-mcp'],                    envVars:[],                                           link:'https://www.npmjs.com/package/@upstash/context7-mcp' },
  { name:'open-meteo',       category:'Weather & Location', desc:'Free weather forecasts, no API key needed',   runner:'npx', args:['-y','-p','open-meteo-mcp-server','open-meteo-mcp-server'], envVars:[],                                      link:'https://www.npmjs.com/package/open-meteo-mcp-server' },
  { name:'openweathermap',   category:'Weather & Location', desc:'Current weather and forecasts',                runner:'npx', args:['-y','mcp-openweathermap'],                         envVars:['OPENWEATHERMAP_API_KEY'],                   link:'https://www.npmjs.com/package/mcp-openweathermap' },
];

// ── State ──────────────────────────────────────────────────────────────────────
const state = {
  telegram_token: '',
  allowed_user_ids: '',
  provider: 'openrouter',
  llm_key: '',
  base_url: '',
  _ollama_models: [],
  model: 'moonshotai/kimi-k2.5',
  max_tokens: '4096',
  system_prompt: 'You are a helpful AI assistant with access to tools. Use the available tools to help the user with their tasks. When using file or terminal tools, operate only within the allowed sandbox directory. Be concise and helpful.',
  location: 'Hong Kong',
  sandbox_dir: '/tmp/rustfox-sandbox',
  db_path: 'rustfox.db',
  mcp_selections: {},
  custom_mcp_servers: [],  // populated from existing config's non-catalog MCP servers
  _loaded: false,          // true when an existing config was successfully loaded
};

// ── Provider constants ─────────────────────────────────────────────────────────
const PROVIDER_DEFAULTS = {
  openrouter: { base_url: 'https://openrouter.ai/api/v1', model: 'moonshotai/kimi-k2.5' },
  ollama:     { base_url: 'http://localhost:11434',        model: '' },
  openai:     { base_url: 'https://api.openai.com/v1',     model: 'gpt-4o' },
};

const OPENAI_MODELS = ['gpt-4o', 'gpt-4o-mini', 'o3-mini', 'o4-mini', 'gpt-4-turbo'];

// ── Step navigation ────────────────────────────────────────────────────────────
const TOTAL_STEPS = 7;
let currentStep = 1;

function showStep(n) {
  document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
  document.getElementById('step-' + n).classList.add('active');
  currentStep = n;
  const WIZARD_STEPS = TOTAL_STEPS - 1; // step 7 is the done page, not a wizard step
  if (n === TOTAL_STEPS) {
    document.getElementById('progress-fill').style.width = '100%';
    document.getElementById('progress-label').textContent = 'Setup complete!';
    document.getElementById('btn-back').style.display = 'none';
    document.getElementById('btn-next').style.display = 'none';
    return;
  }
  const pct = (n / WIZARD_STEPS * 100).toFixed(1);
  document.getElementById('progress-fill').style.width = pct + '%';
  document.getElementById('progress-label').textContent = 'Step ' + n + ' of ' + WIZARD_STEPS;
  document.getElementById('btn-back').style.display = n > 1 ? 'inline-block' : 'none';
  const btnNext = document.getElementById('btn-next');
  btnNext.style.display = 'inline-block';
  btnNext.disabled = false;
  if (n === 1) { btnNext.textContent = 'Get Started →'; }
  else if (n === WIZARD_STEPS) { btnNext.textContent = 'Save config.toml'; }
  else { btnNext.textContent = 'Continue →'; }
  if (n === WIZARD_STEPS) renderPreview();
}

function prevStep() { if (currentStep > 1) showStep(currentStep - 1); }

function nextStep() {
  if (!validateStep(currentStep)) return;
  collectStep(currentStep);
  if (currentStep === TOTAL_STEPS - 1) { saveConfig(); return; }
  showStep(currentStep + 1);
}

// ── Validation ─────────────────────────────────────────────────────────────────
function validateStep(n) {
  let ok = true;
  if (n === 2) {
    ok = requireField('f-telegram-token') & ok;
    ok = requireField('f-allowed-ids') & ok;
  }
  if (n === 3) {
    const p = state.provider;
    if (p === 'openrouter') {
      ok = requireField('f-or-key') & ok;
      ok = requireField('f-or-model') & ok;
    } else if (p === 'ollama') {
      ok = requireField('f-ollama-model') & ok;
    } else if (p === 'openai') {
      ok = requireField('f-oa-key') & ok;
      const sel = document.getElementById('f-oa-model-select');
      if (sel && sel.value === 'custom') {
        ok = requireField('f-oa-model-custom') & ok;
      }
    }
  }
  return !!ok;
}

function requireField(id) {
  const el = document.getElementById(id);
  const errEl = document.getElementById(id + '-err');
  if (!el.value.trim()) {
    el.classList.add('error');
    if (errEl) errEl.classList.add('visible');
    return false;
  }
  el.classList.remove('error');
  if (errEl) errEl.classList.remove('visible');
  return true;
}

// ── Collect form values ────────────────────────────────────────────────────────
function collectStep(n) {
  if (n === 2) {
    state.telegram_token = document.getElementById('f-telegram-token').value.trim();
    state.allowed_user_ids = document.getElementById('f-allowed-ids').value.trim();
  }
  if (n === 3) {
    const p = state.provider;
    if (p === 'openrouter') {
      state.llm_key = document.getElementById('f-or-key').value.trim();
      state.model   = document.getElementById('f-or-model').value.trim();
      state.base_url = PROVIDER_DEFAULTS.openrouter.base_url;
    } else if (p === 'ollama') {
      state.llm_key  = '';
      state.model    = document.getElementById('f-ollama-model').value.trim();
      let rawUrl = (document.getElementById('f-ollama-url').value.trim() || PROVIDER_DEFAULTS.ollama.base_url);
      // normalise: strip trailing /v1 then re-add, to avoid /v1/v1
      rawUrl = rawUrl.replace(/\/v1\/?$/, '');
      state.base_url = rawUrl + '/v1';
    } else if (p === 'openai') {
      state.llm_key  = document.getElementById('f-oa-key').value.trim();
      const sel = document.getElementById('f-oa-model-select');
      state.model = sel.value === 'custom'
        ? document.getElementById('f-oa-model-custom').value.trim()
        : sel.value;
      state.base_url = PROVIDER_DEFAULTS.openai.base_url;
    }
    state.max_tokens    = document.getElementById('f-max-tokens-' + p).value.trim() || '4096';
    state.system_prompt = document.getElementById('f-system-prompt-' + p).value;
    state.location      = document.getElementById('f-location-' + p).value.trim();
  }
  if (n === 4) {
    state.sandbox_dir = document.getElementById('f-sandbox-dir').value.trim() || '/tmp/rustfox-sandbox';
    state.db_path = document.getElementById('f-db-path').value.trim() || 'rustfox.db';
  }
}

// ── TOML generation ────────────────────────────────────────────────────────────
function esc(s) {
  // Escapes for TOML string values only (backslash and double-quote)
  return String(s).replace(/\\/g, '\\\\').replace(/"/g, '\\"');
}

function escHtml(s) {
  // Escapes for HTML attributes and text content
  return String(s)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;');
}

function generateToml() {
  const ids = state.allowed_user_ids.split(/[\s,]+/).filter(Boolean).join(', ');
  const locLine = state.location
    ? 'location = "' + esc(state.location) + '"'
    : '# location = "Your City, Country"';
  const sysprompt = state.system_prompt.replace(/"""/g, '\\"\\"\\"');

  let toml =
    '[telegram]\n' +
    'bot_token = "' + esc(state.telegram_token) + '"\n' +
    'allowed_user_ids = [' + ids + ']\n' +
    '\n' +
    '[llm]\n' +
    'provider = "' + esc(state.provider) + '"\n' +
    'model = "' + esc(state.model) + '"\n' +
    'base_url = "' + esc(state.base_url || (PROVIDER_DEFAULTS[state.provider] && PROVIDER_DEFAULTS[state.provider].base_url) || '') + '"\n' +
    'api_key = "' + esc(state.llm_key) + '"\n' +
    'max_tokens = ' + (parseInt(state.max_tokens, 10) || 4096) + '\n' +
    'system_prompt = """' + sysprompt + '"""\n\n' +
    '[sandbox]\n' +
    'allowed_directory = "' + esc(state.sandbox_dir) + '"\n' +
    '\n' +
    '[memory]\n' +
    'database_path = "' + esc(state.db_path) + '"\n' +
    '\n' +
    '[skills]\n' +
    'directory = "skills"\n' +
    '\n' +
    '[general]\n' +
    locLine + '\n';

  for (const [name, sel] of Object.entries(state.mcp_selections)) {
    if (!sel.selected) continue;
    const tool = MCP_CATALOG.find(t => t.name === name);
    if (!tool) continue;
    const args = tool.args.map(a => '"' + esc(a) + '"').join(', ');
    toml += '\n[[mcp_servers]]\n';
    toml += 'name = "' + name + '"\n';
    toml += 'command = "' + tool.runner + '"\n';
    toml += 'args = [' + args + ']\n';
    if (tool.envVars.length > 0) {
      toml += '[mcp_servers.env]\n';
      for (const k of tool.envVars) {
        toml += k + ' = "' + esc((sel.env && sel.env[k]) || '') + '"\n';
      }
    }
  }

  for (const s of state.custom_mcp_servers) {
    const args = s.args.map(a => '"' + esc(a) + '"').join(', ');
    toml += '\n[[mcp_servers]]\n';
    toml += 'name = "' + esc(s.name) + '"\n';
    toml += 'command = "' + esc(s.command) + '"\n';
    toml += 'args = [' + args + ']\n';
    const envEntries = Object.entries(s.env).filter(([k]) => k.trim());
    if (envEntries.length > 0) {
      toml += '[mcp_servers.env]\n';
      for (const [k, v] of envEntries) {
        toml += k + ' = "' + esc(v) + '"\n';
      }
    }
  }

  return toml;
}

function renderPreview() {
  collectStep(4);
  const pre = document.getElementById('config-preview');
  if (pre) pre.textContent = generateToml();
}

// ── Save ───────────────────────────────────────────────────────────────────────
async function saveConfig() {
  const config = generateToml();
  const btn = document.getElementById('btn-next');
  btn.disabled = true;
  try {
    const res = await fetch('/api/save-config', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ config }),
    });
    const data = await res.json();
    if (data.ok) {
      showStep(TOTAL_STEPS);
    } else {
      btn.disabled = false;
      alert('Server error saving config.');
    }
  } catch (e) {
    btn.disabled = false;
    alert('Failed to save: ' + e.message);
  }
}

// ── MCP interactions ───────────────────────────────────────────────────────────
function toggleTool(name, event) {
  const cb = document.getElementById('mcp-cb-' + name);
  if (event.target !== cb) cb.checked = !cb.checked;
  const wrap = document.getElementById('mcp-wrap-' + name);
  const envDiv = document.getElementById('mcp-env-' + name);
  if (!state.mcp_selections[name]) state.mcp_selections[name] = { selected: false, env: {} };
  state.mcp_selections[name].selected = cb.checked;
  if (cb.checked) {
    wrap.classList.add('selected');
    if (envDiv) envDiv.classList.add('visible');
  } else {
    wrap.classList.remove('selected');
    if (envDiv) envDiv.classList.remove('visible');
  }
}

function setEnv(tool, key, val) {
  if (!state.mcp_selections[tool]) state.mcp_selections[tool] = { selected: true, env: {} };
  if (!state.mcp_selections[tool].env) state.mcp_selections[tool].env = {};
  state.mcp_selections[tool].env[key] = val;
}

// ── Load existing config ────────────────────────────────────────────────────────
async function loadExistingConfig() {
  try {
    const res = await fetch('/api/load-config');
    if (!res.ok) return;
    const cfg = await res.json();
    if (!cfg.exists) return;

    // Populate scalar state fields (non-empty values win over defaults)
    if (cfg.telegram_token)   state.telegram_token   = cfg.telegram_token;
    if (cfg.allowed_user_ids) state.allowed_user_ids = cfg.allowed_user_ids;
    if (cfg.provider)         state.provider         = cfg.provider;
    if (cfg.llm_key)          state.llm_key          = cfg.llm_key;
    if (cfg.base_url)         state.base_url         = cfg.base_url;
    if (cfg.model)            state.model            = cfg.model;
    if (cfg.max_tokens)       state.max_tokens       = String(cfg.max_tokens);
    if (cfg.system_prompt)    state.system_prompt    = cfg.system_prompt;
    if (cfg.location)         state.location         = cfg.location;
    if (cfg.sandbox_dir)      state.sandbox_dir      = cfg.sandbox_dir;
    if (cfg.db_path)          state.db_path          = cfg.db_path;

    // Split MCP servers: catalog-matched vs custom
    for (const s of (cfg.mcp_servers || [])) {
      const inCatalog = MCP_CATALOG.find(c => c.name === s.name);
      if (inCatalog) {
        state.mcp_selections[s.name] = { selected: true, env: s.env || {} };
      } else {
        state.custom_mcp_servers.push({
          name: s.name,
          command: s.command,
          args: s.args || [],
          env: s.env || {},
        });
      }
    }

    state._loaded = true;
  } catch (_) {
    // Network error or JSON parse error — start with blank wizard
  }
}

// ── Custom MCP servers ──────────────────────────────────────────────────────

function renderCustomMcpCards() {
  const el = document.getElementById('custom-mcp-cards');
  if (!el) return;
  if (state.custom_mcp_servers.length === 0) {
    el.innerHTML = '';
    return;
  }
  el.innerHTML = state.custom_mcp_servers.map((s, i) => {
    const cmd = escHtml(s.command) + (s.args.length ? ' ' + s.args.map(escHtml).join(' ') : '');
    const envKeys = Object.keys(s.env);
    return `<div class="custom-card">
  <div class="custom-card-body">
    <div class="custom-card-name">${escHtml(s.name)}</div>
    <div class="custom-card-cmd">${cmd}</div>
    ${envKeys.length ? `<div class="custom-card-env">ENV: ${envKeys.map(escHtml).join(', ')}</div>` : ''}
  </div>
  <button class="btn-remove" onclick="removeCustomServer(${i})" title="Remove">&#x2715;</button>
</div>`;
  }).join('');
}

function removeCustomServer(i) {
  state.custom_mcp_servers.splice(i, 1);
  renderCustomMcpCards();
}

function addCustomEnvRow() {
  const container = document.getElementById('custom-env-rows');
  const row = document.createElement('div');
  row.className = 'env-add-row';
  row.innerHTML = '<input type="text" placeholder="KEY" style="flex:1"><input type="text" placeholder="value" style="flex:2">';
  container.appendChild(row);
}

function syncCustomCmd() {
  const preset = document.getElementById('custom-cmd-preset').value;
  const cmdInput = document.getElementById('custom-cmd');
  if (preset !== 'custom') cmdInput.value = preset;
  cmdInput.readOnly = preset !== 'custom';
}

function addCustomServer() {
  const nameInput = document.getElementById('custom-name');
  const name = nameInput.value.trim();
  if (!name) {
    nameInput.classList.add('error');
    return;
  }
  nameInput.classList.remove('error');

  const command = document.getElementById('custom-cmd').value.trim() || 'npx';
  const argsRaw = document.getElementById('custom-args').value.trim();
  const args = argsRaw ? argsRaw.split(/\s+/) : [];

  const env = {};
  document.getElementById('custom-env-rows').querySelectorAll('.env-add-row').forEach(row => {
    const inputs = row.querySelectorAll('input');
    const k = inputs[0]?.value.trim();
    const v = inputs[1]?.value.trim();
    if (k) env[k] = v || '';
  });

  state.custom_mcp_servers.push({ name, command, args, env });
  renderCustomMcpCards();

  // Reset form
  nameInput.value = '';
  document.getElementById('custom-args').value = '';
  document.getElementById('custom-env-rows').innerHTML = '';
}

// ── Provider tab helpers ────────────────────────────────────────────────────────
function switchProvider(p) {
  state.provider = p;
  document.querySelectorAll('.provider-tab').forEach(t =>
    t.classList.toggle('active', t.dataset.p === p));
  document.querySelectorAll('.provider-panel').forEach(panel =>
    panel.classList.toggle('active', panel.dataset.p === p));
}

function toggleOpenAiCustom() {
  const sel = document.getElementById('f-oa-model-select');
  const wrap = document.getElementById('oa-custom-wrap');
  if (!sel || !wrap) return;
  wrap.classList.toggle('visible', sel.value === 'custom');
}

async function fetchOllamaModels() {
  const btn = document.getElementById('ollama-fetch-btn');
  const status = document.getElementById('ollama-status');
  const inp = document.getElementById('f-ollama-model');
  if (btn) btn.disabled = true;
  if (status) { status.textContent = 'Fetching\u2026'; status.className = 'ollama-status'; }
  try {
    const res = await fetch('/api/ollama-models');
    const data = await res.json();
    if (data.ok && data.models.length > 0) {
      state._ollama_models = data.models;
      if (inp && !inp.value) inp.value = data.models[0];
      if (status) {
        status.textContent = data.models.length + ' model(s) found: ' + data.models.slice(0, 3).join(', ') + (data.models.length > 3 ? '\u2026' : '');
        status.className = 'ollama-status ok';
      }
    } else {
      if (status) { status.textContent = 'Ollama not reachable \u2014 type model name manually'; status.className = 'ollama-status err'; }
    }
  } catch (_) {
    if (status) { status.textContent = 'Fetch failed \u2014 type model name manually'; status.className = 'ollama-status err'; }
  }
  if (btn) btn.disabled = false;
}

// ── Build HTML ─────────────────────────────────────────────────────────────────
function buildSteps() {
  const c = document.getElementById('steps-container');

  // Step 1: Welcome
  c.innerHTML += `<div class="step" id="step-1">
  <h1>Welcome to RustFox</h1>
  <p class="subtitle">
    Your personal AI assistant on Telegram, powered by OpenRouter LLMs and extensible via MCP tools.<br><br>
    This wizard creates your <code>config.toml</code> in about 2 minutes.
    You can always edit it by hand afterwards.
  </p>
  <div id="existing-banner" style="display:none;background:#1a2744;border:1px solid #2b4a8a;border-radius:8px;padding:0.75rem 1rem;font-size:0.85rem;color:#90cdf4">
    <strong style="color:#bee3f8">Editing existing configuration</strong> — all fields pre-loaded from <code>config.toml</code>.
  </div>
</div>`;

  // Step 2: Telegram
  c.innerHTML += `<div class="step" id="step-2">
  <h2>Telegram</h2>
  <div class="field">
    <label>Bot Token <span class="hint">— from @BotFather</span></label>
    <input type="password" id="f-telegram-token" placeholder="1234567890:ABC-..." value="${escHtml(state.telegram_token)}">
    <div class="error-msg" id="f-telegram-token-err">Bot token is required.</div>
  </div>
  <div class="field">
    <label>Allowed User IDs <span class="hint">— comma-separated, from @userinfobot</span></label>
    <input type="text" id="f-allowed-ids" placeholder="123456789, 987654321" value="${escHtml(state.allowed_user_ids)}">
    <div class="error-msg" id="f-allowed-ids-err">At least one user ID is required.</div>
  </div>
</div>`;

  // Step 3: LLM Provider
  const orModel = escHtml(state.provider === 'openrouter' ? state.model : (PROVIDER_DEFAULTS.openrouter.model));
  const ollamaModel = escHtml(state.provider === 'ollama' ? state.model : '');
  const ollamaUrl = escHtml(state.provider === 'ollama' && state.base_url ? state.base_url.replace(/\/v1\/?$/, '') : 'http://localhost:11434');
  const oaKeyVal = escHtml(state.provider === 'openai' ? state.llm_key : '');
  const orKeyVal = escHtml(state.provider === 'openrouter' ? state.llm_key : '');
  const maxTokensVal = escHtml(state.max_tokens || '4096');
  const syspromptVal = escHtml(state.system_prompt);
  const locationVal = escHtml(state.location);
  const oaModelOptions = OPENAI_MODELS.map(m => {
    const selected = (state.provider === 'openai' && state.model === m) ? ' selected' : (m === 'gpt-4o' && state.provider !== 'openai' ? ' selected' : '');
    return `<option value="${escHtml(m)}"${selected}>${escHtml(m)}</option>`;
  }).join('') + `<option value="custom"${state.provider === 'openai' && !OPENAI_MODELS.includes(state.model) && state.model ? ' selected' : ''}>Custom\u2026</option>`;
  const oaCustomModel = escHtml(state.provider === 'openai' && !OPENAI_MODELS.includes(state.model) ? state.model : '');
  const oaCustomVisible = (state.provider === 'openai' && !OPENAI_MODELS.includes(state.model) && state.model) ? ' visible' : '';

  c.innerHTML += `<div class="step" id="step-3">
  <h2>LLM Provider</h2>
  <div class="provider-tabs">
    <button class="provider-tab${state.provider === 'openrouter' ? ' active' : ''}" data-p="openrouter" onclick="switchProvider('openrouter')">OpenRouter</button>
    <button class="provider-tab${state.provider === 'ollama' ? ' active' : ''}" data-p="ollama" onclick="switchProvider('ollama')">Ollama (local)</button>
    <button class="provider-tab${state.provider === 'openai' ? ' active' : ''}" data-p="openai" onclick="switchProvider('openai')">OpenAI</button>
  </div>

  <!-- OpenRouter panel -->
  <div class="provider-panel${state.provider === 'openrouter' ? ' active' : ''}" data-p="openrouter">
    <div class="field">
      <label>API Key <span class="hint">— openrouter.ai/keys</span></label>
      <input type="password" id="f-or-key" placeholder="sk-or-..." value="${orKeyVal}">
      <div class="error-msg" id="f-or-key-err">API key is required.</div>
    </div>
    <div class="field">
      <label>Model <span class="hint">— openrouter.ai/models</span></label>
      <input type="text" id="f-or-model" value="${orModel}">
      <div class="error-msg" id="f-or-model-err">Model is required.</div>
    </div>
    <div class="field">
      <label>Max Tokens</label>
      <input type="text" id="f-max-tokens-openrouter" value="${maxTokensVal}">
    </div>
    <div class="field">
      <label>System Prompt</label>
      <textarea id="f-system-prompt-openrouter">${syspromptVal}</textarea>
    </div>
    <div class="field">
      <label>Location <span class="hint">— optional, gives the AI your timezone/region</span></label>
      <input type="text" id="f-location-openrouter" placeholder="Hong Kong" value="${locationVal}">
    </div>
  </div>

  <!-- Ollama panel -->
  <div class="provider-panel${state.provider === 'ollama' ? ' active' : ''}" data-p="ollama">
    <div class="field">
      <label>Base URL</label>
      <input type="text" id="f-ollama-url" value="${ollamaUrl}">
    </div>
    <div class="field">
      <label>Model</label>
      <div class="ollama-model-row">
        <input type="text" id="f-ollama-model" placeholder="llama3.2" value="${ollamaModel}" style="flex:1">
        <button type="button" class="ollama-fetch-btn" id="ollama-fetch-btn" onclick="fetchOllamaModels()">Fetch models</button>
      </div>
      <div class="ollama-status" id="ollama-status"></div>
      <div class="error-msg" id="f-ollama-model-err">Model name is required.</div>
    </div>
    <div class="field">
      <label>Max Tokens</label>
      <input type="text" id="f-max-tokens-ollama" value="${maxTokensVal}">
    </div>
    <div class="field">
      <label>System Prompt</label>
      <textarea id="f-system-prompt-ollama">${syspromptVal}</textarea>
    </div>
    <div class="field">
      <label>Location <span class="hint">— optional, gives the AI your timezone/region</span></label>
      <input type="text" id="f-location-ollama" placeholder="Hong Kong" value="${locationVal}">
    </div>
  </div>

  <!-- OpenAI panel -->
  <div class="provider-panel${state.provider === 'openai' ? ' active' : ''}" data-p="openai">
    <div class="field">
      <label>API Key <span class="hint">— platform.openai.com/api-keys</span></label>
      <input type="password" id="f-oa-key" placeholder="sk-..." value="${oaKeyVal}">
      <div class="error-msg" id="f-oa-key-err">API key is required.</div>
    </div>
    <div class="field">
      <label>Model</label>
      <select id="f-oa-model-select" onchange="toggleOpenAiCustom()" style="width:100%;background:#0f1117;border:1px solid #2d3748;border-radius:8px;color:#e2e8f0;padding:0.6rem 0.875rem;font-size:0.9rem;">
        ${oaModelOptions}
      </select>
      <div class="openai-custom-wrap${oaCustomVisible}" id="oa-custom-wrap">
        <input type="text" id="f-oa-model-custom" placeholder="enter model name" value="${oaCustomModel}">
        <div class="error-msg" id="f-oa-model-custom-err">Custom model name is required.</div>
      </div>
    </div>
    <div class="field">
      <label>Max Tokens</label>
      <input type="text" id="f-max-tokens-openai" value="${maxTokensVal}">
    </div>
    <div class="field">
      <label>System Prompt</label>
      <textarea id="f-system-prompt-openai">${syspromptVal}</textarea>
    </div>
    <div class="field">
      <label>Location <span class="hint">— optional, gives the AI your timezone/region</span></label>
      <input type="text" id="f-location-openai" placeholder="Hong Kong" value="${locationVal}">
    </div>
  </div>
</div>`;

  // Step 4: Sandbox & Memory
  c.innerHTML += `<div class="step" id="step-4">
  <h2>Sandbox &amp; Memory</h2>
  <div class="field">
    <label>Sandbox Directory <span class="hint">— file/command operations are restricted here</span></label>
    <input type="text" id="f-sandbox-dir" value="${escHtml(state.sandbox_dir || '/tmp/rustfox-sandbox')}">
  </div>
  <div class="field">
    <label>Memory Database Path <span class="hint">— SQLite file for persistent memory</span></label>
    <input type="text" id="f-db-path" value="${escHtml(state.db_path || 'rustfox.db')}">
  </div>
</div>`;

  // Step 5: MCP Tools
  const categories = [...new Set(MCP_CATALOG.map(t => t.category))];
  let html5 = `<div class="step" id="step-5">
  <h2>MCP Tools <span class="hint" style="font-size:0.85rem;font-weight:400">— all optional, can be added later</span></h2>
  <div class="mcp-prereqs">
    <strong>Prerequisites</strong> — MCP servers run as child processes outside RustFox.<br>
    Tools marked <code>uvx</code> need <strong><a href="https://docs.astral.sh/uv/getting-started/installation/" target="_blank" rel="noopener">uv</a></strong> installed &nbsp;(<code>curl -LsSf https://astral.sh/uv/install.sh | sh</code>).<br>
    Tools marked <code>npx</code> need <strong><a href="https://nodejs.org/" target="_blank" rel="noopener">Node.js</a></strong> installed &nbsp;(<a href="https://nodejs.org/en/download/" target="_blank" rel="noopener">nodejs.org/en/download</a>).<br>
    Click <em>docs ↗</em> on any tool to read its full documentation before enabling it.
    Filesystem server requires at least one allowed directory path in args (e.g. your sandbox path).
  </div>`;
  for (const cat of categories) {
    html5 += `<div class="mcp-category"><h3>${cat}</h3>`;
    for (const tool of MCP_CATALOG.filter(t => t.category === cat)) {
      const cmd = tool.runner + ' ' + tool.args.join(' ');
      const envHtml = tool.envVars.map(k => {
        const existingVal = state.mcp_selections[tool.name]?.env?.[k] || '';
        return `<div class="env-row" onclick="event.stopPropagation()">
          <div class="mcp-env-label">${k}</div>
          <input type="text" placeholder="${k}" value="${escHtml(existingVal)}"
                 oninput="setEnv('${tool.name}','${k}',this.value)">
        </div>`;
      }).join('');
      const linkHtml = tool.link
        ? `<a class="mcp-tool-link" href="${tool.link}" target="_blank" rel="noopener" onclick="event.stopPropagation()">docs ↗</a>`
        : '';
      html5 += `<div class="mcp-tool ${state.mcp_selections[tool.name]?.selected ? 'selected' : ''}"
     id="mcp-wrap-${tool.name}" onclick="toggleTool('${tool.name}', event)">
  <div class="mcp-tool-header">
    <input type="checkbox" id="mcp-cb-${tool.name}"
      ${state.mcp_selections[tool.name]?.selected ? 'checked' : ''}
      onclick="event.stopPropagation();toggleTool('${tool.name}',event)">
    <span class="mcp-tool-name">${tool.name}</span>
    ${linkHtml}
  </div>
  <div class="mcp-tool-desc">${tool.desc}</div>
  <div class="mcp-tool-cmd">${cmd}</div>
  ${tool.envVars.length ? `<div class="mcp-env-fields ${state.mcp_selections[tool.name]?.selected ? 'visible' : ''}" id="mcp-env-${tool.name}">${envHtml}</div>` : ''}
</div>`;
    }
    html5 += `</div>`;
  }
  html5 += `<div class="mcp-more">
    Want more tools? Browse the <a href="https://github.com/modelcontextprotocol/servers" target="_blank" rel="noopener">MCP server registry</a>
    or <a href="https://mcp.so/" target="_blank" rel="noopener">mcp.so</a> and add them manually in <code>config.toml</code>.
  </div>
  <div class="custom-mcp-section">
    <h3>Custom Servers</h3>
    <div id="custom-mcp-cards"></div>
    <div class="custom-add-form">
      <h4>Add Custom Server</h4>
      <div class="field">
        <label>Name</label>
        <input type="text" id="custom-name" placeholder="my-server">
      </div>
      <div class="field">
        <label>Command</label>
        <div class="cmd-row">
          <select id="custom-cmd-preset" onchange="syncCustomCmd()">
            <option value="npx">npx</option>
            <option value="uvx">uvx</option>
            <option value="custom">custom...</option>
          </select>
          <input type="text" id="custom-cmd" value="npx" style="flex:1">
        </div>
      </div>
      <div class="field">
        <label>Args <span class="hint">&#8212; space-separated</span></label>
        <input type="text" id="custom-args" placeholder="-y my-mcp-package">
      </div>
      <div class="field">
        <label>Env Vars <span class="hint">&#8212; optional</span></label>
        <div id="custom-env-rows"></div>
        <button type="button" class="btn-secondary" onclick="addCustomEnvRow()" style="margin-top:0.4rem;padding:0.3rem 0.75rem;font-size:0.8rem">+ Add env var</button>
      </div>
      <button type="button" class="btn-primary" onclick="addCustomServer()">Add Server</button>
    </div>
  </div>`;
  html5 += `</div>`;
  c.innerHTML += html5;

  // Step 6: Review & Save
  c.innerHTML += `<div class="step" id="step-6">
  <h2>Review &amp; Save</h2>
  <p style="color:#718096;margin-bottom:1rem;font-size:0.85rem">
    Generated <code>config.toml</code> — will be written to the project root.
  </p>
  <pre id="config-preview"></pre>
</div>`;

  // Step 7: Done / Support
  c.innerHTML += `<div class="step" id="step-7">
  <h1 style="margin-bottom:0.5rem">You're all set!</h1>
  <p class="subtitle">
    <code>config.toml</code> has been saved to the project root.<br>
    Start your bot with:
  </p>
  <pre style="margin-bottom:2rem;text-align:center;font-size:0.95rem;color:#e2e8f0">cargo run --bin rustfox</pre>
  <p style="color:#718096;font-size:0.85rem;margin-bottom:1.25rem;text-align:center">
    If you find RustFox useful, consider supporting the project:
  </p>
  <div style="display:flex;flex-direction:column;gap:0.875rem;align-items:center">
    <a href="https://buymeacoffee.com/chinkan.ai" target="_blank" rel="noopener">
      <img src="https://img.shields.io/badge/Buy%20Me%20a%20Coffee-%E2%98%95-yellow?style=for-the-badge&logo=buy-me-a-coffee" alt="Buy Me a Coffee" style="height:40px">
    </a>
    <a href="https://github.com/sponsors/chinkan" target="_blank" rel="noopener">
      <img src="https://img.shields.io/badge/GitHub%20Sponsors-%E2%9D%A4-pink?style=for-the-badge&logo=github" alt="GitHub Sponsors" style="height:40px">
    </a>
  </div>
</div>`;
}

async function init() {
  await loadExistingConfig();
  buildSteps();
  renderCustomMcpCards();   // populate pre-loaded custom servers into the DOM
  if (state._loaded) {
    document.getElementById('existing-banner').style.display = 'block';
    const locEl = document.getElementById('f-location');
    if (locEl) locEl.value = state.location || '';
  }
  showStep(1);
}
init();
</script>
</body>
</html>
